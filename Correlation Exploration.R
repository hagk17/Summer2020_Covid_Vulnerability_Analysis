
library(MASS)
library(caret)
library(leaps)
library(xlsx)
library(magrittr)
library(factoextra)
library(ggplot2)
library(esquisse)
library(tidyverse)
library(corrplot)


census_data <- read.xlsx("Data/clean_data.xlsx", sheetIndex = 6)
census_data %<>% dplyr::select(-NA.)



###### -------------Correlation Plots ------------------ ######

cor_census <- census_data %>% dplyr::select(-Town, -n_asthma, -p_asthma, -n_occUnitsZero,
                                     -p_occUnitsZero)

alpha_census_data <- cor_census[ , order(names(cor_census))]
count_columns <- c(1:27,55,56)
prop_columns <- c(28:55)

cor_count_data <- alpha_census_data[ ,count_columns]
cor_por_data <- alpha_census_data[ ,prop_columns]

### correlation matrices 
count_cor_matrix <- round(cor(cor_count_data, use="complete.obs", method="pearson"),4)
prop_cor_matrix <- round(cor(cor_por_data, use="complete.obs", method="pearson"), 4)


corrplot(count_cor_matrix, method="circle")
corrplot(count_cor_matrix, method="color", order="hclust",  type = "upper")
corrplot(count_cor_matrix, method="number", type = "upper")

corrplot(count_cor_matrix, method = "circle",  order="hclust",  type = "lower",
         tl.col="black", tl.srt=20)
corrplot(prop_cor_matrix, method = "circle",  order="hclust",  type = "lower",
         tl.col="black", tl.srt=20)




###### ------------- Network Experiment with Count Corrs ------------------ ######

# edge matrix - all 
count2 <- count_cor_matrix
count2[lower.tri(count2, diag = TRUE)] <- NA
nice_cor_matrix <- as.data.frame(cbind(row.names(count2), count2))
edges <- pivot_longer(nice_cor_matrix, -V1) %>% na.omit()
colnames(edges) <- c("from", "to", "weight")

edges <- as.data.frame(cbind(edges, from_id = rep(NA, nrow(edges)), to_id = rep(NA, nrow(edges))))
               


# node matrix 
nodes <- as.data.frame(cbind(Id = 1:29, Variable = c(unique(edges$from), "Total_Cases"), 
                      Description = c("Number of Families w. Income <200% FPL", "Number of Families w. Income <400% FPL",
                 "Number of Individuals 17 Years Old and Younger", "Number of Individuals 65 Years Old and Older",
                 "Number of African Americans", "Number of Individuals with Disabilities",
                 "n_empciv", "n_employed", "Number of Families", "n_famChild",
                 "Number of Family Households on Foodstamps/SNAP", "n_house",
                 "Number of Leisure/Hospitality Workers", "Number of Housing Units w. Incomplete Kitchens",
                 "Number of Families w. Limited English", "Number of Non-White Racial/Ethnic Minorities",
                 "Number w/o Internet Subscription", "Number of Occupied Housing Units",
                 "Number of Housing Units w. Incomplete Plumbing", "Population", "n_rentCost",
                 "Number of Occupied Units Rented", "Number of Employed in Service Industry",
                 "Number of Households on Foodstamps/SNAP", "Number of Single Parent Families w. Children < 18",
                 "Number of All Vacant Units", "Number of Units w. Children <18", 
                 "Population Density", "Total Cases"))
)

#add the node ids to the edges 
for(i in 1:nrow(edges)){
  edges$from_id[i] <- nodes$Id[which(edges$from[i] == nodes$Variable)]
  edges$to_id[i] <- nodes$Id[which(edges$to[i] == nodes$Variable)]
}

# separating the edge matrices by weight 
edges9 <- edges %>% filter(weight >= 0.9) # edge matrix [0.9,1] 
edges8 <- edges %>% filter(weight >= 0.8 & weight<0.9) #edge matrix [0.8,0.9)
edges7 <- edges %>% filter(weight >= 0.7 & weight<0.8) #edge matrix [0.7,0.8)
edges6 <- edges %>% filter(weight < 0.7) #edge matrix with <0.7



### let's play with the networks ###

library(network)

routes_network <- network(edges6, vertex.attr = nodes, matrix.type = "edgelist", ignore.eval = FALSE,
                          directed = FALSE)
class(routes_network)
routes_network
plot(routes_network, vertex.cex = 3)
plot(routes_network, vertex.cex = 3, mode = "circle")

detach(package:network)
rm(routes_network)
library(igraph)

routes_igraph <- graph_from_data_frame(d = edges6, directed = FALSE)
routes_igraph
plot(routes_igraph, edge.arrow.size = 0.2)
plot(routes_igraph, layout = layout_with_graphopt, edge.arrow.size = 0.2)

library(tidygraph)
library(ggraph)

routes_tidy <- tbl_graph(edges = edges6, directed = TRUE)
routes_igraph_tidy <- as_tbl_graph(routes_igraph)

routes_tidy %>% 
  activate(edges) %>% 
  arrange(desc(weight))

ggraph(routes_tidy) + geom_edge_link() + geom_node_point() + theme_graph()

ggraph(routes_tidy, layout = "graphopt") + 
  geom_node_point() +
  geom_edge_link() + 
#  scale_edge_width(range = c(0.2, 2)) +
#  geom_node_text(aes(label = label), repel = TRUE) +
  theme_graph()

library(visNetwork)
library(networkD3)

visNetwork(nodes, edges6)














